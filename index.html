<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Bible Runner</title>
<link rel="icon" type="image/x-icon" href="favicon.ico" />
<style>
  :root{
    --bg1:#71c8ff; --bg2:#c5f0ff; --accent:#ffdd57; --accent2:#ff6f91; --accent3:#7bed9f;
    --ink:#1d3557; --white:#ffffff; --shadow: rgba(0,0,0,0.18);
  }
  html, body { height:100%; margin:0; background:linear-gradient(180deg,var(--bg1),var(--bg2));
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    color:var(--ink); overflow:hidden; }
  #game{ position:fixed; inset:0; }
  .ui{ position:fixed; inset:0; pointer-events:none; }
  .hud{ position:absolute; top:12px; left:12px; right:12px; display:flex; justify-content:space-between; gap:8px; }
  .pill, .badge{ background:rgba(255,255,255,0.85); backdrop-filter:blur(6px); border-radius:14px;
    padding:8px 12px; box-shadow:0 6px 18px var(--shadow); font-weight:800; pointer-events:auto; }
  .title{ position:absolute; top:9vh; width:100%; text-align:center; font-weight:900;
    font-size:clamp(28px,6vw,54px); color:#113152; text-shadow:0 2px 0 rgba(255,255,255,.6), 0 12px 24px var(--shadow);}
  .center-card{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; }
  .card{ pointer-events:auto; background:rgba(255,255,255,0.92); backdrop-filter:blur(8px); border-radius:20px;
    padding:20px; width:min(700px,92vw); box-shadow:0 20px 50px var(--shadow); text-align:center; }
  .buttons{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
  button{ appearance:none; border:0; border-radius:14px; padding:12px 18px; font-weight:800; letter-spacing:.2px; cursor:pointer;
    box-shadow:0 8px 18px var(--shadow); transition:transform .08s ease, filter .1s ease; }
  button:active{ transform:translateY(1px) scale(.995); filter:brightness(.95); }
  .btn-primary{ background:linear-gradient(135deg,var(--accent),#ffd24d); color:#5d4100; }
  .btn-secondary{ background:linear-gradient(135deg,var(--accent2),#ff8fb0); color:#fff; }
  .btn-ghost{ background:rgba(0,0,0,.06); color:var(--ink); }
  .muter{ display:inline-flex; gap:8px; align-items:center; }
  .versetext{ font-size:clamp(16px,3.4vw,22px); line-height:1.35; margin:10px 0 6px; }
  .verse-ref{ font-weight:800; color:#2b5876; margin-bottom:12px; }
  .row{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center; }
  select, .chk{ pointer-events:auto; border-radius:12px; border:0; box-shadow:0 6px 18px var(--shadow);
    padding:10px 12px; font-weight:700; background:rgba(255,255,255,.9); }
  label{ display:inline-flex; align-items:center; gap:8px; }
  .fxbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .fxchip{ background:rgba(255,255,255,.95); border-radius:999px; padding:6px 10px; font-weight:800; box-shadow:0 6px 18px var(--shadow); }
  .footer-tip{ position:absolute; bottom:10px; left:0; right:0; text-align:center; font-size:12px; opacity:.75; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<!-- UI -->
<div class="ui" aria-live="polite">
  <div class="hud">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <div class="pill" id="score">Score: 0</div>
      <div class="pill" id="hiscore">High Score: 0</div>
      <div class="fxbar">
        <div class="fxchip" id="shieldChip" style="display:none">üõ°Ô∏è Shield</div>
        <div class="fxchip" id="slowChip" style="display:none">üê¢ Slow-Mo</div>
        <div class="fxchip" id="superChip" style="display:none">ü¶ò Super Jump</div>
      </div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button id="muteBtn" class="badge muter" aria-label="Toggle sound"><span id="muteIcon">üîä</span> Sound</button>
    </div>
  </div>

  <div class="title" id="title">Bible Runner</div>

  <div class="center-card" id="menu">
    <div class="card">
      <h2>Jump over obstacles & survive üîÜ</h2>
      <p>Double-jump, power-ups, optional jumping obstacles, Goliath, and spoken verses!</p>
      <div class="row" style="margin:8px 0 6px;">
        <select id="themeSel" aria-label="Theme">
          <option value="david">David &amp; Goliath</option>
          <option value="bigfish">Jonah and the Big Fish</option>
          <option value="ark">Noah &amp; the Ark</option>
          <option value="paul">Paul (Apostle)</option>
        </select>
        <label class="chk"><input type="checkbox" id="assistChk"/> Assist Mode (slower ramp)</label>
        <label class="chk"><input type="checkbox" id="jumpersChk"/> Disable jumping obstacles</label>
      </div>
      <div class="buttons">
        <button class="btn-primary" id="startBtn">Start Game</button>
        <button class="btn-secondary" id="howBtn">How to Play</button>
      </div>
      <div class="footer-tip">Parallax desert ‚Ä¢ Cartoon Bible themes ‚Ä¢ ESV verse (spoken) on bonk</div>
    </div>
  </div>

  <div class="center-card" id="how" style="display:none">
    <div class="card">
      <h2>How to Play</h2>
      <ul style="text-align:left; margin:10px auto; width:fit-content;">
        <li><b>Jump</b>: Space / ‚Üë / click / tap (double-jump works)</li>
        <li>üõ°Ô∏è Shield: invulnerable ‚Ä¢ üê¢ Slow-Mo: time dilation ‚Ä¢ ü¶ò Super Jump: 5s higher jumps</li>
        <li>Optional: disable jumping obstacles for younger players</li>
        <li>On hit, a short ESV verse shows and is <b>read aloud</b></li>
      </ul>
      <div class="buttons">
        <button class="btn-primary" id="howBack">Got it!</button>
      </div>
    </div>
  </div>

  <div class="center-card" id="gameover" style="display:none">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="gohead">
      <h2 id="gohead">Bonk! You hit an obstacle üí•</h2>
      <div class="versetext" id="verseText"></div>
      <div class="verse-ref" id="verseRef"></div>
      <div class="buttons">
        <button class="btn-primary" id="retryBtn">Retry</button>
        <button class="btn-secondary" id="newVerseBtn">New Verse</button>
        <button class="btn-ghost" id="copyVerseBtn">Copy Verse</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== Canvas =====
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  function resize() {
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    canvas.style.width = innerWidth + 'px';
    canvas.style.height = innerHeight + 'px';
    canvas.width = Math.floor(innerWidth * dpr);
    canvas.height = Math.floor(innerHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', resize); resize();

  const rand = (a=1,b=0)=>Math.random()*(a-b)+b;
  const pick = arr=>arr[(Math.random()*arr.length)|0];

  const VERSES = [
    {t:"Jesus wept.", r:"John 11:35 (ESV)"},
    {t:"Rejoice always,", r:"1 Thessalonians 5:16 (ESV)"},
    {t:"pray without ceasing,", r:"1 Thessalonians 5:17 (ESV)"},
    {t:"Do not quench the Spirit.", r:"1 Thessalonians 5:19 (ESV)"},
    {t:"Abstain from every form of evil.", r:"1 Thessalonians 5:22 (ESV)"},
    {t:"The LORD is my shepherd; I shall not want.", r:"Psalm 23:1 (ESV)"},
    {t:"In the beginning, God created the heavens and the earth.", r:"Genesis 1:1 (ESV)"},
    {t:"Your word is a lamp to my feet and a light to my path.", r:"Psalm 119:105 (ESV)"},
    {t:"When I am afraid, I put my trust in you.", r:"Psalm 56:3 (ESV)"},
    {t:"For everyone who calls on the name of the Lord will be saved.", r:"Romans 10:13 (ESV)"},
    {t:"This is the day that the LORD has made; let us rejoice and be glad in it.", r:"Psalm 118:24 (ESV)"},
    {t:"The grass withers, the flower fades, but the word of our God will stand forever.", r:"Isaiah 40:8 (ESV)"},
    {t:"He who calls you is faithful; he will surely do it.", r:"1 Thessalonians 5:24 (ESV)"},
    {t:"The LORD is near to the brokenhearted and saves the crushed in spirit.", r:"Psalm 34:18 (ESV)"},
    {t:"A joyful heart is good medicine, but a crushed spirit dries up the bones.", r:"Proverbs 17:22 (ESV)"},
  ];

  // ===== Audio (and controls speech mute) =====
  const AudioFX = (() => {
    const Ctx = new (window.AudioContext||window.webkitAudioContext)();
    let muted=false;
    const env=(osc,t0,a=.01,d=.08,s=.0,r=.12,g=.2)=>{
      const gain=Ctx.createGain(); gain.gain.setValueAtTime(0,t0);
      gain.gain.linearRampToValueAtTime(g,t0+a);
      gain.gain.linearRampToValueAtTime(g*s,t0+a+d);
      gain.gain.exponentialRampToValueAtTime(0.0001,t0+a+d+r);
      osc.connect(gain).connect(Ctx.destination); return gain;
    };
    const chirp=(t,f1,f2,dur,type='square')=>{
      if(muted) return; const o=Ctx.createOscillator(); o.type=type;
      o.frequency.setValueAtTime(f1,t); o.frequency.exponentialRampToValueAtTime(f2,t+dur*0.9);
      env(o,t,.005,.05,.3,.12,.3); o.start(t); o.stop(t+dur);
    };
    function setMuted(m){ muted=m; if(m && speechSynthesis) speechSynthesis.cancel(); }
    function isMuted(){ return muted; }
    function resume(){ if (Ctx.state === 'suspended') Ctx.resume(); }
    return {
      jump(){ chirp(Ctx.currentTime,520,980,0.16,'square'); },
      djump(){ chirp(Ctx.currentTime,700,1200,0.12,'triangle'); },
      bonk(){ const t=Ctx.currentTime; const o=Ctx.createOscillator(); o.type='sawtooth';
        o.frequency.setValueAtTime(220,t); o.frequency.exponentialRampToValueAtTime(80,t+0.25);
        env(o,t,.005,.05,.5,.35,.35); o.start(t); o.stop(t+0.28); },
      milestone(){ const t=Ctx.currentTime; [523.25,659.25,783.99].forEach((f,i)=>{ const o=Ctx.createOscillator();
        o.type=i%2?'triangle':'sine'; o.frequency.setValueAtTime(f,t+i*0.02);
        env(o,t+i*0.02,.005,.08,.4,.25,.25); o.start(t+i*0.02); o.stop(t+0.3+i*0.02); }); },
      click(){ const t=Ctx.currentTime; const o=Ctx.createOscillator(); o.type='square'; o.frequency.setValueAtTime(880,t);
        env(o,t,.001,.03,.0,.04,.25); o.start(t); o.stop(t+0.06); },
      pickup(){ chirp(Ctx.currentTime,660,1320,0.14,'sine'); },
      shieldHit(){ chirp(Ctx.currentTime,400,200,0.08,'square'); },
      woosh(){ const t=Ctx.currentTime; const o=Ctx.createOscillator(); o.type='triangle';
        o.frequency.setValueAtTime(200,t); o.frequency.exponentialRampToValueAtTime(80,t+0.5);
        env(o,t,.005,.15,.3,.4,.35); o.start(t); o.stop(t+0.5); },
      super(){ const t=Ctx.currentTime; const o=Ctx.createOscillator(); o.type='square';
        o.frequency.setValueAtTime(300,t); o.frequency.exponentialRampToValueAtTime(900,t+0.25);
        env(o,t,.005,.12,.4,.45,.4); o.start(t); o.stop(t+0.5); },
      setMuted, isMuted, resume
    };
  })();

  // ===== Speech (reads verse aloud) =====
  function speak(text) {
    if (!('speechSynthesis' in window)) return;
    if (AudioFX.isMuted()) return;
    try { speechSynthesis.cancel(); } catch(e){}
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
    const voices = speechSynthesis.getVoices();
    const en = voices.find(v => /en/i.test(v.lang));
    if (en) u.voice = en;
    speechSynthesis.speak(u);
  }

  // ===== Input =====
  let jumpQueued=false;
  const queueJump=()=>{ jumpQueued=true; AudioFX.resume(); };
  addEventListener('keydown', e=>{
    if([' ','ArrowUp','Spacebar'].includes(e.key)){ e.preventDefault(); queueJump(); }
  }, {passive:false});
  addEventListener('pointerdown', queueJump, {passive:true});

  // ===== UI =====
  const $=s=>document.querySelector(s);
  const scoreEl=$('#score'), hiscoreEl=$('#hiscore'), titleEl=$('#title');
  const menuEl=$('#menu'), howEl=$('#how'), goEl=$('#gameover');
  const verseTextEl=$('#verseText'), verseRefEl=$('#verseRef');
  const startBtn=$('#startBtn'), retryBtn=$('#retryBtn'), howBtn=$('#howBtn'), howBackBtn=$('#howBack');
  const newVerseBtn=$('#newVerseBtn'), copyVerseBtn=$('#copyVerseBtn');
  const muteBtn=$('#muteBtn'), muteIcon=$('#muteIcon');
  const themeSel=$('#themeSel'), assistChk=$('#assistChk'), jumpersChk=$('#jumpersChk');
  const shieldChip=$('#shieldChip'), slowChip=$('#slowChip'), superChip=$('#superChip');

  function showMenu(b=true){ menuEl.style.display=b?'':'none'; howEl.style.display='none'; goEl.style.display='none'; titleEl.style.display=b?'':'none';}
  function showHow(b=true){ menuEl.style.display='none'; howEl.style.display=b?'':'none';}
  function showGameOver(b=true){ goEl.style.display=b?'':'none'; titleEl.style.display='none';}
  function setVerse(v){ verseTextEl.textContent='"'+v.t+'"'; verseRefEl.textContent=v.r; }
  function randomVerse(){ return pick(VERSES); }

  startBtn.addEventListener('click', ()=>{ AudioFX.click(); startGame(); });
  retryBtn.addEventListener('click', ()=>{ AudioFX.click(); startGame(); });
  howBtn.addEventListener('click', ()=>{ AudioFX.click(); showHow(true); });
  howBackBtn.addEventListener('click', ()=>{ AudioFX.click(); showMenu(true); });
  newVerseBtn.addEventListener('click', ()=>{ AudioFX.click(); const v=randomVerse(); setVerse(v); speak(`${v.t} ‚Äî ${v.r}`); });
  copyVerseBtn.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(`${verseTextEl.textContent} ‚Äî ${verseRefEl.textContent}`); copyVerseBtn.textContent='Copied!'; setTimeout(()=>copyVerseBtn.textContent='Copy Verse', 900); }catch{}
  });
  muteBtn.addEventListener('click', ()=>{ AudioFX.setMuted(!AudioFX.isMuted()); muteIcon.textContent=AudioFX.isMuted()?'üîá':'üîä'; AudioFX.click(); });

  // ===== Game State =====
  const G = {
    state:'menu',
    score:0, hiscore: parseInt(localStorage.getItem('mbtg_highscore')||'0',10),
    time:0, theme:'david', assist:false, noJumpers:false,
    baseSpeed:280, gravity:1600, jumpVel:540, groundY:()=>Math.floor(innerHeight*0.78),
    obstacles:[], powerups:[], bosses:[], nextSpawn:0, nextPU:3, nextBoss:18,
    effects:{ shield:0, slowmo:0, super:0 }
  };
  themeSel.addEventListener('change', ()=> G.theme = themeSel.value);
  assistChk.addEventListener('change', ()=> G.assist = assistChk.checked);
  jumpersChk.addEventListener('change', ()=> G.noJumpers = jumpersChk.checked);

  // ===== Entities =====
  class Player{
    constructor(){ this.reset(); }
    reset(){
      this.w=44; this.h=54;
      this.x=Math.max(40, innerWidth*0.17);
      this.y=G.groundY()-this.h;
      this.vy=0; this.onGround=true; this.blink=0;
      this.jumpsLeft=2;
    }
    jump(){
      if(this.jumpsLeft>0){
        const first = this.jumpsLeft===2;
        const superBoost = (1 + (G.effects.super>0 ? 0.45 : 0));
        this.vy = -G.jumpVel * (first?1:0.9) * superBoost;
        this.onGround=false; this.jumpsLeft--;
        first?AudioFX.jump():AudioFX.djump();
      }
    }
    update(dt){
      this.vy += G.gravity*dt*(G.effects.super>0 ? 0.92 : 1);
      this.y += this.vy*dt;
      const gy=G.groundY()-this.h;
      if(this.y>=gy){ this.y=gy; this.vy=0; if(!this.onGround){ this.onGround=true; this.jumpsLeft=2; } }
      if(this.blink>0) this.blink-=dt;
    }
    aabb(){ return {x:this.x+6,y:this.y+6,w:this.w-12,h:this.h-12}; }
    draw(ctx){
      const x=this.x,y=this.y,w=this.w,h=this.h;
      ctx.save();
      ctx.translate(0, Math.sin(G.time* (G.effects.slowmo>0?10:20)) * 1.0);

      // effect glows
      if(G.effects.shield>0){
        ctx.fillStyle='rgba(255,255,255,.35)';
        ctx.beginPath(); ctx.ellipse(x+w/2,y+h/2, w*0.7, h*0.8, 0, 0, Math.PI*2); ctx.fill();
      }
      if(G.effects.super>0){
        const puls = 0.5 + 0.5*Math.sin(G.time*10);
        ctx.fillStyle=`rgba(255,221,87,${0.18+0.12*puls})`;
        ctx.beginPath(); ctx.ellipse(x+w/2,y+h/2, w*0.9, h*1.0, 0, 0, Math.PI*2); ctx.fill();
      }

      // legs/feet
      ctx.fillStyle = '#5c3d2e'; ctx.fillRect(x+10,y+h-10,8,10); ctx.fillRect(x+26,y+h-10,8,10);
      ctx.fillStyle = '#3b261a'; ctx.fillRect(x+8,y+h-3,12,3); ctx.fillRect(x+24,y+h-3,12,3);

      // outfit by theme
      if(G.theme==='david'){ // shepherd + sling
        const tun = ctx.createLinearGradient(x,y,x,y+h); tun.addColorStop(0,'#ffd77a'); tun.addColorStop(1,'#ffb347');
        ctx.fillStyle=tun; ctx.beginPath(); ctx.moveTo(x+8,y+16); ctx.lineTo(x+w-8,y+16); ctx.lineTo(x+w-4,y+h-10); ctx.lineTo(x+4,y+h-10); ctx.closePath(); ctx.fill();
        ctx.fillStyle='#f4c49b'; ctx.fillRect(x+2,y+22,10,8); ctx.fillRect(x+w-12,y+22,10,8);
        ctx.fillStyle='#f4c49b'; ctx.fillRect(x+12,y,20,20);
        ctx.fillStyle='#8b5e34'; ctx.fillRect(x+10,y+6,24,4);
        if(this.blink>0){ ctx.fillStyle='#000'; ctx.fillRect(x+16,y+10,16,2); } else { ctx.fillStyle='#000'; ctx.fillRect(x+16,y+9,3,3); ctx.fillRect(x+28,y+9,3,3); ctx.fillStyle='#0008'; ctx.fillRect(x+20,y+14,8,2); }
        ctx.strokeStyle='#7d4f22'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x+w-4,y+24); ctx.quadraticCurveTo(x+w+10,y+12,x+w-2,y+4); ctx.stroke();

      } else if(G.theme==='bigfish'){ // Jonah and the Big Fish
        ctx.fillStyle='#78d1ff'; ctx.fillRect(x+8,y+16,w-16,h-26);
        ctx.fillStyle='#f4c49b'; ctx.fillRect(x+12,y,20,20);
        ctx.fillStyle='#003e7c'; ctx.fillRect(x+12,y-4,20,8); // cap
        ctx.fillStyle='#0aa'; ctx.beginPath(); ctx.moveTo(x+w-6,y+20); ctx.lineTo(x+w+6,y+26); ctx.lineTo(x+w-4,y+30); ctx.closePath(); ctx.fill(); // fish charm
        if(this.blink>0){ ctx.fillStyle='#000'; ctx.fillRect(x+16,y+10,16,2); } else { ctx.fillStyle='#000'; ctx.fillRect(x+16,y+9,3,3); ctx.fillRect(x+28,y+9,3,3); ctx.fillStyle='#0008'; ctx.fillRect(x+20,y+14,8,2); }

      } else if(G.theme==='ark'){ // Noah & the Ark (wood tones + plank)
        // robe/light shirt
        ctx.fillStyle='#e6f7ff'; ctx.fillRect(x+8,y+16,w-16,h-26);
        // wooden vest
        const wood = ctx.createLinearGradient(x,y,x,y+h);
        wood.addColorStop(0,'#b07a47'); wood.addColorStop(1,'#8a5a2b');
        ctx.fillStyle=wood; ctx.fillRect(x+10,y+20,w-20,h-30);
        // head
        ctx.fillStyle='#f4c49b'; ctx.fillRect(x+12,y,20,20);
        // small plank carried
        ctx.fillStyle='#8a5a2b'; ctx.fillRect(x+w-12,y+24,14,6);
        // eyes/smile
        if(this.blink>0){ ctx.fillStyle='#000'; ctx.fillRect(x+16,y+10,16,2); }
        else { ctx.fillStyle='#000'; ctx.fillRect(x+16,y+9,3,3); ctx.fillRect(x+28,y+9,3,3); ctx.fillStyle='#0008'; ctx.fillRect(x+20,y+14,8,2); }

      } else { // paul (Apostle) ‚Äî neutral browns, black hair/beard, sandals
        // Neutral brown robe
        const robe = ctx.createLinearGradient(x,y,x,y+h);
        robe.addColorStop(0,'#c9a57c'); robe.addColorStop(1,'#a2784e');
        ctx.fillStyle=robe; ctx.fillRect(x+8,y+16,w-16,h-26);

        // Head
        ctx.fillStyle='#f4c49b'; ctx.fillRect(x+12,y,20,20);
        // Hair (black) cap and sides
        ctx.fillStyle='#111'; ctx.fillRect(x+12,y-2,20,6);         // top hair
        ctx.fillRect(x+10,y+4,4,12); ctx.fillRect(x+30,y+4,4,12);  // side hair
        // Beard (black)
        ctx.fillRect(x+14,y+14,16,6);

        // Scroll in hand
        ctx.fillStyle='#ffe8b6'; ctx.fillRect(x+w-14,y+22,10,8);
        ctx.fillStyle='#c89f6e'; ctx.fillRect(x+w-16,y+22,4,8);

        // Sandals
        ctx.fillStyle='#3b261a'; // straps
        ctx.fillRect(x+10,y+h-6,8,2); ctx.fillRect(x+26,y+h-6,8,2);
        ctx.fillStyle='#23160e'; // soles
        ctx.fillRect(x+8,y+h-3,12,3); ctx.fillRect(x+24,y+h-3,12,3);

        // Eyes / smile
        if(this.blink>0){
          ctx.fillStyle='#000'; ctx.fillRect(x+16,y+10,16,2);
        } else {
          ctx.fillStyle='#000';
          ctx.fillRect(x+16,y+9,3,3); ctx.fillRect(x+28,y+9,3,3);
          ctx.fillStyle='#0008'; ctx.fillRect(x+20,y+14,8,2);
        }
      }
      ctx.restore();
    }
  }

  class Obstacle{
    constructor(type,x){
      this.type=type;
      this.w= type==='jar'?34 : type==='scroll'?40 : type==='shield'?36 : 36;
      this.h= type==='scroll'?30 : 32;
      if(type==='wave'){ this.w=42; this.h=28; }
      if(type==='branch' || type==='plank'){ this.w=38; this.h=28; }
      this.x=x; this.y=G.groundY()-this.h; this.spin=rand(0,Math.PI*2);
      this.jumper = (!G.noJumpers) && Math.random()<0.25;
      this.vy=0; this.jumpTimer=rand(0.8,1.8);
    }
    update(dt,speed){
      this.x-=speed*dt;
      this.spin+=dt*(this.type==='shield'?5:2.5);
      if(this.jumper){
        this.jumpTimer-=dt;
        if(this.jumpTimer<=0 && this.onGround()){
          this.vy = - (280 + Math.random()*120);
          this.jumpTimer = rand(1.0,2.0);
        }
        this.vy += G.gravity*dt*0.8;
        this.y += this.vy*dt;
        const gy=G.groundY()-this.h;
        if(this.y>=gy){ this.y=gy; this.vy=0; }
      }
    }
    onGround(){ return this.y >= G.groundY()-this.h-0.5; }
    offscreen(){ return this.x+this.w<-60; }
    aabb(){ return {x:this.x+4, y:this.y+4, w:this.w-8, h:this.h-6}; } /* <-- FIXED */
    draw(ctx){
      const x=this.x,y=this.y,w=this.w,h=this.h;
      if(G.theme==='bigfish' && this.type==='wave'){
        ctx.save(); ctx.translate(x+w/2,y+h/2); ctx.rotate(Math.sin(this.spin)*0.12); ctx.translate(-w/2,-h/2);
        ctx.fillStyle='#3ec0ff'; ctx.beginPath(); ctx.moveTo(0,h); ctx.quadraticCurveTo(w*0.3,0,w,h); ctx.lineTo(w,h); ctx.closePath(); ctx.fill();
        ctx.fillStyle='#ffffffbb'; ctx.fillRect(w*0.3,4, w*0.4,3); ctx.restore(); return;
      }
      if(G.theme==='ark' && (this.type==='plank' || this.type==='branch')){
        ctx.save(); ctx.translate(x+w/2,y+h/2); ctx.rotate(Math.sin(this.spin)*0.1); ctx.translate(-w/2,-h/2);
        ctx.fillStyle='#7a5230'; ctx.fillRect(2, h/2-4, w-4, 8);
        ctx.fillStyle='#5e3e20'; ctx.fillRect(w*0.2, h/2-3, w*0.6, 2);
        ctx.restore(); return;
      }
      if(this.type==='jar'){
        ctx.save(); ctx.translate(x+w/2,y+h/2); ctx.rotate(Math.sin(this.spin)*0.08); ctx.translate(-w/2,-h/2);
        const grad=ctx.createLinearGradient(0,0,0,h); grad.addColorStop(0,'#d08c60'); grad.addColorStop(1,'#b87544'); ctx.fillStyle=grad;
        ctx.beginPath(); ctx.moveTo(4,0); ctx.lineTo(w-4,0); ctx.quadraticCurveTo(w,h*0.6,w-6,h); ctx.lineTo(6,h); ctx.quadraticCurveTo(0,h*0.6,4,0); ctx.fill();
        ctx.fillStyle='#8e5a3a'; ctx.fillRect(w/2-8,-2,16,6); ctx.restore();
      } else if(this.type==='scroll'){
        ctx.save(); ctx.translate(x+w/2,y+h/2); ctx.rotate(Math.sin(this.spin)*0.12); ctx.translate(-w/2,-h/2);
        ctx.fillStyle='#ffe8b6'; ctx.fillRect(4,2,w-8,h-4);
        ctx.fillStyle='#c89f6e'; ctx.fillRect(0,0,6,h); ctx.fillRect(w-6,0,6,h);
        ctx.fillStyle='#0002'; ctx.fillRect(8,8,w-16,2); ctx.fillRect(8,14,w-16,2); ctx.restore();
      } else { // shield
        ctx.save(); ctx.translate(x+w/2,y+h/2); ctx.rotate(this.spin);
        const r=Math.min(w,h)/2; ctx.fillStyle='#b4d455'; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#7eb338'; ctx.beginPath(); ctx.arc(0,0,r*0.65,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#fff'; ctx.fillRect(-2,-r,4,r*2); ctx.fillRect(-r,-2,r*2,4);
        ctx.restore();
      }
    }
  }

  class PowerUp {
    constructor(kind, x){
      this.kind = kind; // 'shield' | 'slowmo' | 'super'
      this.w = 28; this.h = 28;
      this.x = x; this.y = G.groundY() - this.h - 40 - Math.random()*40;
      this.phase = Math.random()*Math.PI*2;
    }
    update(dt, speed){
      this.x -= speed*dt*0.8;
      this.y += Math.sin((G.time*2)+this.phase)*0.3;
    }
    offscreen(){ return this.x+this.w < -60; }
    aabb(){ return {x:this.x+2, y:this.y+2, w:this.w-4, h:this.h-4}; } /* <-- FIXED */
    draw(ctx){
      const x=this.x, y=this.y, w=this.w, h=this.h;
      if(this.kind==='shield'){
        ctx.save(); ctx.translate(x+w/2, y+h/2);
        ctx.fillStyle='#7bed9f'; ctx.beginPath(); ctx.arc(0,0, w/2, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle='#ffffffcc'; ctx.fillRect(-2,-w/2,4,w); ctx.fillRect(-w/2,-2,w,4); ctx.restore();
      } else if(this.kind==='slowmo'){
        ctx.save(); ctx.translate(x+w/2, y+h/2);
        ctx.fillStyle='#8ecbff'; ctx.beginPath(); ctx.arc(0,0, w/2, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle='#ffffffcc'; ctx.beginPath(); ctx.arc(0,0, w/3, 0, Math.PI*2); ctx.fill(); ctx.restore();
      } else {
        ctx.save(); ctx.translate(x+w/2, y+h/2);
        ctx.fillStyle='#ffdd57'; ctx.beginPath(); ctx.arc(0,0, w/2, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle='#ffffffcc'; ctx.beginPath(); ctx.moveTo(-5,4); ctx.lineTo(0,-6); ctx.lineTo(5,4); ctx.lineTo(0,2); ctx.closePath(); ctx.fill();
        ctx.restore();
      }
    }
  }

  class BossGoliath {
    constructor(){
      this.w = Math.max(160, innerWidth*0.2);
      this.h = Math.max(160, innerHeight*0.35);
      this.x = innerWidth + 20;
      this.y = G.groundY() - this.h + 20;
      this.speed = 90; this.pauseX = innerWidth*0.4 + Math.random()*80;
      this.paused = false; this.pauseT = 0;
    }
    update(dt){
      if(!this.paused){
        this.x -= this.speed * dt * (G.effects.slowmo>0 ? 0.6 : 1);
        if(this.x <= this.pauseX){ this.paused = true; this.pauseT = 2.2; }
      } else {
        this.pauseT -= dt * (G.effects.slowmo>0 ? 0.6 : 1);
        if(this.pauseT <= 0){ this.paused = false; }
      }
    }
    offscreen(){ return this.x + this.w < -60; }
    aabb(){ return {x:this.x+12, y:this.y+20, w:this.w-24, h:this.h-30}; }
    draw(ctx){
      const x=this.x,y=this.y,w=this.w,h=this.h;
      ctx.fillStyle='#3b261a'; ctx.fillRect(x+10, y+h-18, 44, 12); ctx.fillRect(x+w-54, y+h-18, 44, 12);
      ctx.fillStyle='#5c3d2e'; ctx.fillRect(x+22, y+h-80, 20, 62); ctx.fillRect(x+w-42, y+h-80, 20, 62);
      const tun = ctx.createLinearGradient(x,y,x,y+h); tun.addColorStop(0,'#b6e36a'); tun.addColorStop(1,'#7eb338'); ctx.fillStyle=tun;
      ctx.fillRect(x+18, y+40, w-36, h-100);
      ctx.fillStyle='#f1c89a'; ctx.fillRect(x, y+80, 24, 16); ctx.fillRect(x+w-24, y+80, 24, 16);
      ctx.fillStyle='#f1c89a'; ctx.fillRect(x+w/2-28, y, 56, 56);
      ctx.fillStyle='#000'; ctx.fillRect(x+w/2-12, y+18, 6, 6); ctx.fillRect(x+w/2+6, y+18, 6, 6);
      ctx.fillStyle='#0007'; ctx.fillRect(x+w/2-10, y+34, 20, 4);
      ctx.fillStyle='#b4d455'; ctx.beginPath(); ctx.arc(x+36, y+110, 20, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle='#7eb338'; ctx.beginPath(); ctx.arc(x+36, y+110, 12, 0, Math.PI*2); ctx.fill();
    }
  }

  // ===== Helpers & Parallax (with Ark crates) =====
  function drawMountain(x,baseY,width,height){ ctx.beginPath(); ctx.moveTo(x,baseY); ctx.lineTo(x+width*0.4,baseY-height); ctx.lineTo(x+width,baseY); ctx.closePath(); ctx.fill(); }
  function drawClouds(offset,scale){ const w=innerWidth; for(let i=0;i<4;i++){ const cx=(i*300 + (offset*(0.6+scale)))%(w+320)-160; const cy=80+i*12+scale*30;
    ctx.fillStyle='rgba(255,255,255,0.9)'; bubble(cx,cy,24*scale); bubble(cx+24,cy-8,28*scale); bubble(cx+48,cy,24*scale); }
    function bubble(x,y,r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); } }
  function drawDuneBand(x,y,h,w){ ctx.beginPath(); ctx.moveTo(x,y); ctx.quadraticCurveTo(x+w*0.25,y-h,x+w*0.5,y);
    ctx.quadraticCurveTo(x+w*0.75,y+h*0.5,x+w,y); ctx.lineTo(x+w,y+200); ctx.lineTo(x,y+200); ctx.closePath(); ctx.fill(); }
  function drawCrate(x,y,scale=1){
    const w = 28*scale, h = 24*scale;
    ctx.save(); ctx.translate(x,y);
    ctx.fillStyle = '#a27341'; ctx.fillRect(0,0,w,h);
    ctx.fillStyle = '#8a5a2b'; ctx.fillRect(0,4,w,3); ctx.fillRect(0,10,w,3); ctx.fillRect(0,16,w,3);
    ctx.fillRect(0,0,3,h); ctx.fillRect(w-3,0,3,h);
    ctx.fillStyle = 'rgba(0,0,0,0.15)';
    ctx.beginPath(); ctx.arc(w*0.35,h*0.55,3,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(w*0.6,h*0.65,3,0,Math.PI*2); ctx.fill();
    ctx.fillRect(w*0.2,h*0.7,w*0.6,2);
    ctx.restore();
  }

  const parallax = {
    t:0,
    draw(ctx,dt){
      const w=innerWidth, h=innerHeight; this.t+=dt;
      const sunX=(w*0.15 + Math.sin(G.time*0.05)*20), sunY=h*0.18;
      ctx.fillStyle='#ffd86b'; ctx.beginPath(); ctx.arc(sunX,sunY,40,0,Math.PI*2); ctx.fill();
      const baseY=h*0.62;
      ctx.fillStyle='#9bd1ff'; drawMountain(-200+(-G.time*30)%(w+300), baseY, w*0.6, 90);
      ctx.fillStyle='#7bbff3'; drawMountain(50+(-G.time*45)%(w+300), baseY+20, w*0.65, 100);
      drawClouds(this.t*15, 0.25); drawClouds(this.t*25, 0.5);
      if(G.theme==='bigfish'){
        ctx.fillStyle='#9be1ff'; drawDuneBand((-G.time*110)%(w*2), h*0.72, h*0.08, w);
        ctx.fillStyle='#5ec9ff'; drawDuneBand((-G.time*160)%(w*2), h*0.78, h*0.1, w);
      } else {
        ctx.fillStyle='#f7d487'; drawDuneBand((-G.time*110)%(w*2), h*0.7, h*0.08, w);
        ctx.fillStyle='#f0c56a'; drawDuneBand((-G.time*160)%(w*2), h*0.76, h*0.1, w);
      }
      ctx.fillStyle = G.theme==='bigfish' ? '#68d1ff' : '#eab75b';
      ctx.fillRect(0, G.groundY(), w, h - G.groundY());
      ctx.fillStyle = G.theme==='bigfish' ? '#bff0ff' : '#9cc56b';
      for(let i=0;i<6;i++){ const gx=(i*240 + (-G.time*200)%(w+240)) - 40; ctx.fillRect(gx, G.groundY()-6, 8, 12); ctx.fillRect(gx+6, G.groundY()-8, 6, 14); }

      // Ark theme: decorative animal crates
      if (G.theme === 'ark') {
        const baseY = G.groundY() - 24;
        for (let i=0; i<4; i++){
          const laneY = baseY - (i%2)*10;
          const x = ((i*340) + (-G.time*180) % (innerWidth+360)) - 60;
          drawCrate(x, laneY, 1);
        }
      }
    }
  };

  const player = new Player();

  // ===== Pools =====
  const typesDefault = ['jar','scroll','shield'];
  const typesFish   = ['wave','scroll','shield'];
  const typesArk    = ['plank','scroll','shield'];

  // ===== Game flow =====
  function startGame(){
    G.state='play'; G.score=0; G.time=0;
    G.obstacles.length=0; G.powerups.length=0; G.bosses.length=0;
    G.nextSpawn=0; G.nextPU=rand(3,6); G.nextBoss=rand(16,24);
    G.effects.shield=0; G.effects.slowmo=0; G.effects.super=0;
    shieldChip.style.display=slowChip.style.display=superChip.style.display='none';
    try{ speechSynthesis && speechSynthesis.cancel(); }catch(e){}
    player.reset(); showMenu(false); showGameOver(false);
  }
  function gameOver(){
    G.state='over'; player.blink=0.6; AudioFX.bonk();
    if(G.score>G.hiscore){ G.hiscore=G.score; localStorage.setItem('mbtg_highscore', String(G.hiscore)); setTimeout(()=>AudioFX.milestone(),150); }
    const v=randomVerse(); setVerse(v);
    speak(`${v.t} ‚Äî ${v.r}`);
    showGameOver(true);
  }

  // ===== Main loop =====
  let last=performance.now();
  function loop(now){
    const rawDt=(now-last)/1000; const dt=Math.min(0.033, rawDt);
    last=now;

    const worldScale = (G.effects.slowmo>0) ? 0.6 : 1.0;
    const wdt = dt * worldScale;

    ctx.clearRect(0,0,innerWidth,innerHeight);
    parallax.draw(ctx,wdt);

    if(G.state==='menu'){
      player.update(dt*0.7); player.draw(ctx);
    } else if(G.state==='play'){
      G.time+=dt;

      // Effects
      if(G.effects.shield>0){ G.effects.shield-=dt; if(G.effects.shield<0) G.effects.shield=0; }
      if(G.effects.slowmo>0){ G.effects.slowmo-=dt; if(G.effects.slowmo<0) G.effects.slowmo=0; }
      if(G.effects.super>0){ G.effects.super-=dt; if(G.effects.super<0) G.effects.super=0; }
      shieldChip.style.display = G.effects.shield>0 ? '' : 'none';
      slowChip.style.display = G.effects.slowmo>0 ? '' : 'none';
      superChip.style.display = G.effects.super>0 ? '' : 'none';

      // Speed & score
      const ramp = G.assist ? 0.6 : 1.0;
      const baseSpeed = (G.baseSpeed + 90*Math.sqrt(G.time)) * (0.9 + 0.1*Math.tanh(G.time*0.25)) * ramp;

      const oldScore = G.score;
      G.score = Math.floor(G.time * 11);
      if(G.score>0 && G.score%150===0 && G.score!==oldScore) AudioFX.milestone();

      if(jumpQueued){ jumpQueued=false; player.jump(); }

      player.update(wdt);
      player.draw(ctx);

      // Spawns
      G.nextSpawn -= wdt;
      if(G.nextSpawn<=0){
        const baseGap = G.assist ? 1.5 : 1.2;
        const gap = Math.max(0.6, baseGap - (G.time/25));
        G.nextSpawn = gap * (0.8 + Math.random()*0.6);
        let pool = typesDefault;
        if(G.theme==='bigfish') pool = typesFish;
        else if(G.theme==='ark') pool = typesArk;
        const type = pick(pool);
        G.obstacles.push(new Obstacle(type, innerWidth + rand(0,120)));
      }

      G.nextPU -= wdt;
      if(G.nextPU<=0){
        const r = Math.random();
        const kind = r < 0.4 ? 'shield' : r < 0.7 ? 'slowmo' : 'super';
        G.powerups.push(new PowerUp(kind, innerWidth + 20));
        G.nextPU = rand(8,13);
      }

      G.nextBoss -= wdt;
      if(G.nextBoss<=0){
        G.bosses.push(new BossGoliath());
        G.nextBoss = rand(22,34);
      }

      // Updates & draws
      for(let i=G.obstacles.length-1;i>=0;i--){
        const o=G.obstacles[i]; o.update(wdt, baseSpeed); o.draw(ctx);
        if(o.offscreen()) G.obstacles.splice(i,1);
      }
      for(let i=G.powerups.length-1;i>=0;i--){
        const p=G.powerups[i]; p.update(wdt, baseSpeed); p.draw(ctx);
        if(p.offscreen()) G.powerups.splice(i,1);
      }
      for(let i=G.bosses.length-1;i>=0;i--){
        const b=G.bosses[i]; b.update(wdt); b.draw(ctx);
        if(b.offscreen()) G.bosses.splice(i,1);
      }

      // Collisions
      const pa=player.aabb();

      // powerups
      for(let i=G.powerups.length-1;i>=0;i--){
        const p=G.powerups[i]; const a=p.aabb();
        if(pa.x < a.x+a.w && pa.x+pa.w > a.x && pa.y < a.y+a.h && pa.y+pa.h > a.y){
          if(p.kind==='shield'){ G.effects.shield = Math.max(G.effects.shield, 6.0); AudioFX.pickup(); }
          else if(p.kind==='slowmo'){ G.effects.slowmo = Math.max(G.effects.slowmo, 4.0); AudioFX.woosh(); }
          else { G.effects.super = Math.max(G.effects.super, 5.0); AudioFX.super(); }
          G.powerups.splice(i,1);
        }
      }

      // bosses
      for(const b of G.bosses){
        const a=b.aabb();
        if(pa.x < a.x+a.w && pa.x+pa.w > a.x && pa.y < a.y+a.h && pa.y+pa.h > a.y){
          if(G.effects.shield>0){
            player.vy = -Math.abs(player.vy) - 320; player.blink = 0.3; AudioFX.shieldHit();
          } else {
            gameOver();
          }
        }
      }

      // obstacles
      for(const o of G.obstacles){
        const a=o.aabb();
        if(pa.x < a.x+a.w && pa.x+pa.w > a.x && pa.y < a.y+a.h && pa.y+pa.h > a.y){
          if(G.effects.shield>0){
            o.x -= 20; o.y -= 12; G.effects.shield = Math.max(0, G.effects.shield - 1.2);
            player.blink = 0.25; AudioFX.shieldHit();
          } else {
            gameOver();
          }
          break;
        }
      }
    } else { // over
      player.update(dt*0.5); player.draw(ctx);
      for(const o of G.obstacles) o.draw(ctx);
      for(const b of G.bosses) b.draw(ctx);
    }

    scoreEl.textContent=`Score: ${G.score}`;
    hiscoreEl.textContent=`High Score: ${G.hiscore}`;
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // init UI
  function setVerse(v){ verseTextEl.textContent='"'+v.t+'"'; verseRefEl.textContent=v.r; }
  function randomVerse(){ return pick(VERSES); }
  function showMenu(b=true){ menuEl.style.display=b?'':'none'; howEl.style.display='none'; goEl.style.display='none'; titleEl.style.display=b?'':'none';}
  function showGameOver(b=true){ goEl.style.display=b?'':'none'; titleEl.style.display='none';}
  showMenu(true);
})();
</script>
</body>
</html>

